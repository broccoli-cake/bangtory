<!DOCTYPE html>
<html>
  <head>
    <title>ì†Œì…œ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</title>
    <style>
      .button {
        padding: 10px 20px;
        margin: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }
      .kakao {
        background-color: #FEE500;
        color: #000000;
      }
      .google {
        background-color: #4285F4;
        color: white;
      }
      .naver {
        background-color: #1EC800;
        color: white;
      }
      .logout {
        background-color: #FF0000;
        color: white;
      }
      .card {
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        background: #fafafa;
        text-align: center;
        cursor: pointer;
        font-size: 18px;
      }
      .card:hover {
        background: #f0f0f0;
      }
      .input {
        width: 200px;
        padding: 8px;
        margin: 8px 0;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>ì†Œì…œ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h1>
      <div id="auth-container">
        <!-- ì—¬ê¸°ì— ë²„íŠ¼ì´ ë™ì ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
      </div>
    </div>

    <script>
      // ìƒíƒœë³„ë¡œ í™”ë©´ì„ ê·¸ë¦¬ëŠ” í•¨ìˆ˜ë“¤
      function renderProfileForm(user) {
        const container = document.getElementById('auth-container');
        container.innerHTML = `
          <p>ë¡œê·¸ì¸ë¨: ${user.displayName}</p>
          <a href="/auth/logout" class="button logout">ë¡œê·¸ì•„ì›ƒ</a>
          <hr>
          <h2>í”„ë¡œí•„ ì„¤ì •</h2>
          <form id="profileForm">
            <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„" required class="input"><br>
            <input type="text" id="profileImageUrl" placeholder="í”„ë¡œí•„ ì´ë¯¸ì§€ URL" class="input"><br>
            <button type="submit" class="button" style="background:#ff5a5f;color:#fff;">ì €ì¥</button>
          </form>
          <div id="profileResult"></div>
        `;
        document.getElementById('profileForm').onsubmit = async function(e) {
          e.preventDefault();
          const nickname = document.getElementById('nickname').value;
          const profileImageUrl = document.getElementById('profileImageUrl').value;
          const body = { nickname };
          if (profileImageUrl.trim()) body.profileImageUrl = profileImageUrl;
          const res = await fetch('/profiles/me', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const result = await res.json();
          document.getElementById('profileResult').innerText = JSON.stringify(result, null, 2);
          if (result.resultCode === '201' || result.resultCode === '200') {
            setTimeout(() => renderRoomChoice(user), 1000);
          }
        };
      }

      function renderRoomChoice(user) {
        const container = document.getElementById('auth-container');
        container.innerHTML = `
          <p>ì•ˆë…•í•˜ì„¸ìš”, ${user.displayName}ë‹˜!</p>
          <a href="/auth/logout" class="button logout">ë¡œê·¸ì•„ì›ƒ</a>
          <hr>
          <div class="card" id="createRoomBtn">+ ë°© ë§Œë“¤ê¸°</div>
          <div class="card" id="joinRoomBtn">ë°© ë“¤ì–´ê°€ê¸°</div>
        `;
        document.getElementById('createRoomBtn').onclick = () => renderCreateRoomForm(user);
        document.getElementById('joinRoomBtn').onclick = () => renderJoinRoomForm(user);
      }

      function renderCreateRoomForm(user) {
        const container = document.getElementById('auth-container');
        container.innerHTML = `
          <p>ë°© ì´ë¦„ì„ ì •í•´ì£¼ì„¸ìš”.</p>
          <form id="createRoomForm">
            <input type="text" id="roomName" placeholder="ë°© ì´ë¦„" required class="input"><br>
            <input type="text" id="address" placeholder="ì˜ˆ: íŒêµëŒ€ë¡œ 235, ë°˜ë‹¬ ì£¼ì†Œ, ì²­ë…„ë‹¹ 6íšŒ" class="input"><br>
            <button type="submit" class="button" style="background:#ff5a5f;color:#fff;">ë°© ë§Œë“¤ê¸°</button>
          </form>
          <div id="roomResult"></div>
        `;
        document.getElementById('createRoomForm').onsubmit = async function(e) {
          e.preventDefault();
          const roomName = document.getElementById('roomName').value;
          const address = document.getElementById('address').value;
          const res = await fetch('/rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roomName, address })
          });
          const result = await res.json();
          document.getElementById('roomResult').innerText = JSON.stringify(result, null, 2);
          if (result.resultCode === '201' && result.room) {
            setTimeout(() => renderMainRoom(result.room, user), 1000);
          }
        };
      }

      function renderJoinRoomForm(user) {
        const container = document.getElementById('auth-container');
        container.innerHTML = `
          <p>ë°© ì½”ë“œ(ë˜ëŠ” ID)ë¡œ ë°©ì— ì…ì¥í•˜ì„¸ìš”.</p>
          <form id="joinRoomForm">
            <input type="text" id="inviteCode" placeholder="ë°© ì½”ë“œ ë˜ëŠ” ID" required class="input"><br>
            <button type="submit" class="button" style="background:#ff5a5f;color:#fff;">ë°© ì…ì¥í•˜ê¸°</button>
          </form>
          <div id="joinRoomResult"></div>
        `;
        document.getElementById('joinRoomForm').onsubmit = async function(e) {
          e.preventDefault();
          const inviteCode = document.getElementById('inviteCode').value;
          const res = await fetch('/rooms/join', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ inviteCode })
          });
          const result = await res.json();
          document.getElementById('joinRoomResult').innerText = JSON.stringify(result, null, 2);
          if (result.resultCode === '200' && result.data) {
            renderMainRoom(result.data, user);
          }
        };
      }

      async function renderMainRoom(roomInfo, user) {
        const container = document.getElementById('auth-container');
        // 1. ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        let categories = [];
        try {
          const res = await fetch('/chores');
          const data = await res.json();
          categories = Array.isArray(data.data) ? data.data : [];
        } catch (e) {
          categories = [];
        }

        const members = Array.isArray(roomInfo.members) ? roomInfo.members : [];
        const myChores = Array.isArray(roomInfo.myChores) ? roomInfo.myChores : [];
        const todaySchedules = Array.isArray(roomInfo.todaySchedules) ? roomInfo.todaySchedules : [];

        container.innerHTML = `
          <div style="padding:16px;">
            <h2>${roomInfo.roomName}</h2>
            <div style="color:#888; font-size:14px;">${roomInfo.address || ''}</div>
            <div style="margin:16px 0;">
              <b>ë©¤ë²„:</b>
              ${members.map(m => `<span style="margin-right:8px;">${m.nickname}${m.isOwner ? 'ğŸ‘‘' : ''}</span>`).join('')}
            </div>
            <hr>
            <div>
              <b>ì§‘ì•ˆì¼ ì¹´í…Œê³ ë¦¬</b>
              <div id="category-list" style="margin:8px 0;">
                ${categories.map(c => `<span id="cat-${c._id}" style="display:inline-block;padding:6px 12px;margin:4px;border-radius:16px;background:#eee;cursor:pointer;">${c.icon} ${c.name}</span>`).join('')}
                <button id="addCategoryBtn" class="button" style="padding:4px 10px;font-size:14px;">+ ì¶”ê°€</button>
              </div>
              <div id="addCategoryForm" style="display:none; margin-top:8px;">
                <input type="text" id="newCategoryName" placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„" class="input" style="width:120px;">
                <input type="text" id="newCategoryIcon" placeholder="ì•„ì´ì½˜(ì´ëª¨ì§€)" class="input" style="width:80px;">
                <button id="submitCategoryBtn" class="button" style="padding:4px 10px;font-size:14px;">ë“±ë¡</button>
                <button id="cancelCategoryBtn" class="button" style="padding:4px 10px;font-size:14px;background:#ccc;">ì·¨ì†Œ</button>
              </div>
              <div id="categoryResult"></div>
            </div>
            <hr>
            <div>
              <b>ë‚´ í•  ì¼</b>
              <ul>
                ${myChores.length === 0 ? '<li>í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>' : myChores.map(chore => `<li>${chore.date} - ${chore.category.icon} ${chore.category.name}</li>`).join('')}
              </ul>
            </div>
            <div>
              <b>ì˜¤ëŠ˜ ì¼ì •</b>
              <ul>
                ${todaySchedules.length === 0 ? '<li>ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>' : todaySchedules.map(sch => `<li>${sch.category.icon} ${sch.category.name} - ${sch.assignedTo.nickname}</li>`).join('')}
              </ul>
            </div>
            <button class="button logout" onclick="location.reload()">ë¡œê·¸ì•„ì›ƒ/ì²˜ìŒìœ¼ë¡œ</button>
          </div>
        `;

        // + ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ í¼ í‘œì‹œ
        document.getElementById('addCategoryBtn').onclick = () => {
          document.getElementById('addCategoryForm').style.display = 'block';
        };
        // ì·¨ì†Œ ë²„íŠ¼
        document.getElementById('cancelCategoryBtn').onclick = () => {
          document.getElementById('addCategoryForm').style.display = 'none';
        };
        // ë“±ë¡ ë²„íŠ¼
        document.getElementById('submitCategoryBtn').onclick = async () => {
          const name = document.getElementById('newCategoryName').value;
          const icon = document.getElementById('newCategoryIcon').value;
          const res = await fetch('/chores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, icon })
          });
          const result = await res.json();
          document.getElementById('categoryResult').innerText = result.resultMessage;
          if (result.resultCode === '201') {
            // ë“±ë¡ ì„±ê³µ ì‹œ ëª©ë¡ ê°±ì‹ 
            renderMainRoom(roomInfo, user);
          }
        };

        // ì¹´í…Œê³ ë¦¬ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
        categories.forEach(c => {
          const el = document.getElementById('cat-' + c._id);
          if (el) {
            el.onclick = () => renderChoreScheduleView(roomInfo, user, c);
          }
        });
      }

      async function renderChoreScheduleView(roomInfo, user, category) {
        const container = document.getElementById('auth-container');
        // ì¼ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        let schedules = [];
        try {
          const res = await fetch(`/chores/schedules?roomId=${roomInfo.roomId || roomInfo._id}&categoryId=${category._id}`);
          const data = await res.json();
          schedules = Array.isArray(data.data) ? data.data : [];
        } catch (e) {
          schedules = [];
        }

        container.innerHTML = `
          <div style="padding:16px;">
            <button class="button" onclick="window._renderMainRoom && window._renderMainRoom(window._roomInfo, window._user)">â† ë’¤ë¡œ</button>
            <h2>${category.icon} ${category.name} ì¼ì •</h2>
            <ul>
              ${schedules.length === 0 ? '<li>ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>' : schedules.map(s => `<li>${s.date} - ë‹´ë‹¹: ${s.assignedTo?.nickname || '-'} ${s.isCompleted ? 'âœ…' : ''}</li>`).join('')}
            </ul>
            <hr>
            <h3>ìƒˆ ì¼ì • ë“±ë¡</h3>
            <form id="addScheduleForm">
              <input type="date" id="scheduleDate" required class="input">
              <button type="submit" class="button" style="padding:4px 10px;">ë“±ë¡</button>
            </form>
            <div id="scheduleResult"></div>
          </div>
        `;

        // ë’¤ë¡œê°€ê¸° ê¸°ëŠ¥ì„ ìœ„í•´ ì „ì—­ì— ì €ì¥
        window._renderMainRoom = renderMainRoom;
        window._roomInfo = roomInfo;
        window._user = user;

        document.getElementById('addScheduleForm').onsubmit = async function(e) {
          e.preventDefault();
          const date = document.getElementById('scheduleDate').value;
          // ë‹´ë‹¹ìëŠ” í˜„ì¬ ë¡œê·¸ì¸ ìœ ì €ë¡œ ê³ ì •(í…ŒìŠ¤íŠ¸ìš©)
          const res = await fetch('/chores/schedules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              room: roomInfo.roomId || roomInfo._id,
              category: category._id,
              assignedTo: user.id || user._id,
              date
            })
          });
          const result = await res.json();
          document.getElementById('scheduleResult').innerText = result.resultMessage;
          if (result.resultCode === '201') {
            // ë“±ë¡ ì„±ê³µ ì‹œ ë‹¤ì‹œ ì¼ì • ëª©ë¡ ê°±ì‹ 
            renderChoreScheduleView(roomInfo, user, category);
          }
        };
      }

      // ìµœì´ˆ ì§„ì… ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
      fetch('/auth/status')
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('auth-container');
          if (data.isAuthenticated) {
            // í”„ë¡œí•„ ì„¤ì •ë¶€í„° ì‹œì‘
            renderProfileForm(data.user);
          } else {
            container.innerHTML = `
              <a href="/auth/kakao" class="button kakao">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</a>
              <a href="/auth/google" class="button google">êµ¬ê¸€ ë¡œê·¸ì¸</a>
              <a href="/auth/naver" class="button naver">ë„¤ì´ë²„ ë¡œê·¸ì¸</a>
            `;
          }
        });
    </script>
  </body>
</html>